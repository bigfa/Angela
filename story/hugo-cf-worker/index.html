<!doctype html><html lang=zh-cn prefix="og: http://ogp.me/ns#"><head><title>Hugo 使用 Cloudflare Worker 实现文章浏览计数与点赞 - Untitled</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,minimal-ui,shrink-to-fit=no"><link rel=stylesheet href=https://bigfa.github.io/hugo-theme-notability/scss/app.min.91802b9a856f04f7b78eaee5648f65b63e766eab3eee1fde4ab661faef88e9ab.css integrity="sha256-kYArmoVvBPe3jq7lZI9ltj52bqs+7h/eSrZh+u+I6as=" media=screen><link type=image/vnd.microsoft.icon href=/hugo-theme-notability/images/favicon.png rel="shortcut icon"><meta property="og:title" content="Hugo 使用 Cloudflare Worker 实现文章浏览计数与点赞"><meta property="og:url" content="https://bigfa.github.io/hugo-theme-notability/story/hugo-cf-worker/"><meta property="og:image" content><meta property="og:description" content="Hugo 使用 Cloudflare Worker 实现文章浏览计数与点赞"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content><meta name=twitter:title content="Hugo 使用 Cloudflare Worker 实现文章浏览计数与点赞"><meta name=twitter:description content="Hugo 使用 Cloudflare Worker 实现文章浏览计数与点赞"></head><body><script>window.DEFAULT_THEME="",localStorage.getItem("theme")==null&&localStorage.setItem("theme",window.DEFAULT_THEME),localStorage.getItem("theme")=="dark"&&document.querySelector("body").classList.add("dark"),localStorage.getItem("theme")=="auto"&&document.querySelector("body").classList.add("auto")</script><header class="metabar metabar--bordered"><div class="metabar--block layoutSingleColumn" itemprop=publisher itemscope itemtype=https://schema.org/Organization><h1 class=metabar--headline itemprop=logo itemscope itemtype=https://schema.org/ImageObject><a href=https://bigfa.github.io/hugo-theme-notability/ class=metabar--logo><img src=/hugo-theme-notability/images/logo.png class=metabar--logoImage width=38 height=47></a></h1><nav class=site--nav><a href=/hugo-theme-notability/movies/>书影音</a>
<a href=/hugo-theme-notability/categories/>分类</a>
<a href=/hugo-theme-notability/story/>文章</a>
<a href=/hugo-theme-notability/tags/>标签</a>
<a href=/hugo-theme-notability/gears/>设备</a>
<a href=/hugo-theme-notability/about/>关于</a>
<a href=/hugo-theme-notability/friends/>链接</a></nav><svg class="menu--icon" width="1em" height="1em" viewBox="0 0 24 14" fill="currentcolor" aria-hidden="true"><line x1="24" y1="1" y2="1" stroke="currentcolor" stroke-width="2"/><line x1="24" y1="7" x2="4" y2="7" stroke="currentcolor" stroke-width="2"/><line x1="24" y1="13" x2="8" y2="13" stroke="currentcolor" stroke-width="2"/></svg></div></header><div class=mask></div><main class=main><div class="layoutSingleColumn u-paddingTop50 u-xs-paddingTop15 post--single" data-id=57740e8b16c5f031c415f492a3828ce5><h2 class=article--headline>Hugo 使用 Cloudflare Worker 实现文章浏览计数与点赞</h2><div class=article--subline>Hugo 使用 Cloudflare Worker 实现文章浏览计数与点赞</div><div class=article--meta><time datetime='2024-05-13 15:31:05' class=humane--time>2024-05-13 15:31:05</time>
<span class=dot></span>
<a href=/hugo-theme-notability/categories/hugo/>Hugo</a>
<span class=dot></span>
<span class=article--views></span></div><details class=toc open><summary class=toc-title>目录</summary><nav id=TableOfContents><ul><li><a href=#本地开发>本地开发</a></li><li><a href=#部署>部署</a><ul><li><a href=#手动部署>手动部署</a></li><li><a href=#github-action-自动部署>Github Action 自动部署</a></li><li><a href=#域名绑定>域名绑定</a></li></ul></li><li><a href=#前端调用>前端调用</a></li></ul></nav></details><div class="content graph"><p>一直以来我对静态博客都没什么兴趣，主要原因是静态博客都是 MD 文件转网页，各种平台都是大同小异，只展示博文还好，如果实现一些其他计数功能，如点赞评论啥的都要额外部署服务，这样还不如直接用动态博客了。如果有研究过我的 hugo 主题会发现我的数据存储都是使用 Markdown 文章文件的，也算原汁原味的静态博客。</p><p>引入外部服务理论上啥功能都能实现，但那其实和静态博客已经没啥关系了。前阵子 Google domains 停止服务，我就把域名转到了 Cloudflare，顺便研究了一下自带的功能，发现用 Cloudflare 的免费方案搭建一个简单的数据统计服务是没啥成本的，于是就有了本文。</p><ul><li>Cloudflare 免费方案的额度对普通用户来说完全够用，如果不够用付费就好了，毕竟大流量也很容易变现。</li><li>Cloudflare Worker 的域名无法直接访问，需要自己绑定域名。</li><li>前端调用需要解决跨域问题。</li><li>静态博客没有文章 id 的概念，需要设置一个 key，hugo 有个文件路径的 md5 可以作为 UniqueId。</li></ul><p><a href=https://github.com/bigfa/hugo-cf-worker target=_blank rel=noopener>项目地址</a></p><p>直接 <code>git clone</code> 或者 <code>use template</code>.</p><p>需要手动修改 <code>wrangler.toml</code> 设置跨域域名和绑定<code>d1</code>数据库。</p><pre tabindex=0><code>[vars]
DOMAIN = &#34;https://bigfa.github.io&#34;
</code></pre><p>这个域名是你要跨域的域名，可以设置为*，这样就没有任何限制了。</p><pre tabindex=0><code>[[d1_databases]]
binding = &#34;DB&#34;
database_name = &#34;hugo-cf-d1&#34;
database_id = &#34;81e23e8a-3b26-4025-acf8-1123bfd5af74&#34;
</code></pre><p><code>database_name</code> 和 <code>database_id</code> 是你需要修改的，可在 Cloudflare 后台看到。</p><h3 id=本地开发>本地开发</h3><p>Cloudflare 的命令行工具是 <code>wrangler</code>，需要 nodejs 环境。<code>wrangler</code> 使用过程中如果没登陆授权会弹出网页授权，授权即可。</p><p>进入项目目录，安装依赖。</p><pre tabindex=0><code>npm install
</code></pre><p>创建数据库，如果已经在后台创建则无需执行这一步。</p><pre tabindex=0><code>npx wrangler d1 execute create hugo-cf-d1
</code></pre><p>本地创建数据表，Cloudflare 本地和远程是分开的，如果后续手动部署，则需要在远程生产环境数据库创建表。</p><pre tabindex=0><code>npx wrangler d1 execute hugo-cf-d1 --local --file=./schema.sql
</code></pre><p>之后即可启动项目</p><pre tabindex=0><code>npm run dev
</code></pre><h3 id=部署>部署</h3><h4 id=手动部署>手动部署</h4><p>如果生产环境数据库没有创建表则需要执行命令初始化。</p><pre tabindex=0><code>npx wrangler d1 execute hugo-cf-d1 --file=./schema.sql
</code></pre><p>然后部署即可。</p><pre tabindex=0><code>npm run deploy
</code></pre><h4 id=github-action-自动部署>Github Action 自动部署</h4><p>进入 Github 项目的设置，<code>Settings->Secrets and variables->Actions->Repository secret</code>，新增一个<code>secret</code>，命名为 <code>CLOUDFLARE_API_TOKEN</code>。如果需要修改数据库名需要编辑<code>.github/workflows/deploy.yml</code>,<code>hugo-cf-d1</code> 就是数据库名。</p><pre tabindex=0><code>wrangler d1 execute hugo-cf-d1 --file=./schema.sql
</code></pre><p><a href=https://dash.cloudflare.com/profile/api-tokens target=_blank rel=noopener>密钥设置地址</a>
，注意要给 D1 的编辑权限。</p><h4 id=域名绑定>域名绑定</h4><p><img src=//static.fatesinger.com/2024/05/xm2jaov6erphd72a.png alt></p><p>我的域名本身就在 cloudflare，估计使用 cloudflare 的 DNS 解析也可以。</p><h3 id=前端调用>前端调用</h3><p>本人的两款主题天然支持，只需要在在配置文件中开启即可。</p><pre tabindex=0><code>post_like = true
post_view = true
actionDomain = &#39;https://v.wpista.com/&#39;
</code></pre><p><code>actionDomain</code> 就是你 Worker 中绑定的域名。</p><p>如果其他主题想使用，可复制我主题里的<code>assets/ts/utils.ts</code> 和<code>assets/ts/action.ts</code>两个文件到你的主题中。</p><p>调用方法。</p><pre tabindex=0><code>new farallonActions({
    singleSelector: &#34;.post--single&#34;, // 判断是否是文章详情页的class
    articleSelector: &#34;.post--item&#34;, // 列表文章条目 class
    likeButtonSelctor: &#34;.like-btn&#34;, // 点赞按钮 class
    viewSelector: &#34;.views&#34;, // 浏览量 class
    actionDomain: &#34;你的域名&#34;, // worker 域名
    text: &#34;&#34;, // 浏览量后面的文案
});
</code></pre><p>根据你主题的情况具体适配，<code>actionDomain</code> 为必须设置的参数。</p><p>最后就是不管是 hugo 还是 wordpress 都强烈建议使用本人全家桶。</p></div><div class=post--single__action><button class="button--like like-btn" aria-label="like the post">
<svg class="icon--active" viewBox="0 0 1024 1024" width="32" height="32"><path d="M780.8 204.8c-83.2-44.8-179.2-19.2-243.2 44.8L512 275.2l-25.6-25.6c-64-64-166.4-83.2-243.2-44.8-134.4 70.4-153.6 236.8-57.6 332.8l32 32 153.6 153.6 102.4 102.4c25.6 25.6 57.6 25.6 83.2.0l102.4-102.4 153.6-153.6 32-32C934.4 441.6 915.2 275.2 780.8 204.8z"/></svg>
<svg class="icon--default" viewBox="0 0 1024 1024" width="32" height="32"><path d="M332.8 249.6c38.4.0 83.2 19.2 108.8 44.8L467.2 320 512 364.8 556.8 320l25.6-25.6c32-32 70.4-44.8 108.8-44.8 19.2.0 38.4 6.4 57.6 12.8 44.8 25.6 70.4 57.6 76.8 108.8 6.4 44.8-6.4 89.6-38.4 121.6L512 774.4 236.8 492.8c-32-32-51.2-76.8-44.8-121.6s38.4-83.2 76.8-108.8C288 256 313.6 249.6 332.8 249.6m0-64C300.8 185.6 268.8 192 243.2 204.8 108.8 275.2 89.6 441.6 185.6 537.6l281.6 281.6C480 832 499.2 838.4 512 838.4s32-6.4 38.4-19.2L832 537.6c96-96 76.8-262.4-57.6-332.8-25.6-12.8-57.6-19.2-89.6-19.2-57.6.0-115.2 25.6-153.6 64L512 275.2l-25.6-25.6c-38.4-38.4-96-64-153.6-64z"/></svg>
<span class=count></span></button></div><div class="article--tags u-paddingTop20"></div><div class=postCat--item><img src=https://static.fatesinger.com/2023/06/u1ak8xgmyn9ec24r.png class=cover><div class=postCat--content><a href=/hugo-theme-notability/categories/hugo/ class=artile--category>Hugo</a><p>hugo</p></div></div></div></main><footer class=site--footer><div class=layoutSingleColumn><div class=copyright>Theme by <a href=https://fatesinger.com/74850 target=_blank>bigfa</a>
© 版权所有
2024</div></div></footer><div class=backToTop><svg xmlns="http://www.w3.org/2000/svg" class="svgIcon" viewBox="0 0 14 14" fill="currentcolor" aria-hidden="true"><path d="M7.50015.425011C7.42998.354396 7.34632.298622 7.25415.261011c-.18314-.074008-.38786-.074008-.571.0C6.59128.298643 6.50795.354423 6.43815.425011L.728147 6.13201c-.13248.14218-.204603.33022-.201175.52452C.530401 6.85084.609113 7.03622.746526 7.17363c.137413.13742.322794.21613.517094.21956C1.45793 7.39661 1.64597 7.32449 1.78815 7.19201l4.428-4.427V13.024C6.21615 13.2229 6.29517 13.4137 6.43582 13.5543 6.57647 13.695 6.76724 13.774 6.96615 13.774 7.16506 13.774 7.35583 13.695 7.49648 13.5543 7.63713 13.4137 7.71615 13.2229 7.71615 13.024V2.76501l4.42795 4.427c.1427.13666.3325.21296.529999999999999.21296C12.8717 7.40497 13.0615 7.32867 13.2041 7.19201 13.3444 7.05126 13.4231 6.86068 13.4231 6.66201 13.4231 6.46334 13.3444 6.27277 13.2041 6.13201L7.50015.425011z"/></svg></div><script type=text/javascript>window.WPD_TOKEN="",window.commentDomain="https://fatesinger.com/__api/v1",window.actionDomain="https://v.wpista.com/",window.viewText=" 次浏览",window.dbAPIBase="https://dbapi.wpista.com/"</script><script type=text/javascript>window.timeFormat={second:"秒前",seconds:"秒前",minute:"",minutes:"",hour:"小时前",hours:"小时前",day:"天前",days:"天前",month:"月前",months:"月前"}</script><script type=text/javascript src=/hugo-theme-notability/ts/bundle.js defer></script></body></html>