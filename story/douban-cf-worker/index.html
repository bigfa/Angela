<!doctype html><html lang=zh-cn prefix="og: http://ogp.me/ns#"><head><title>使用 Cloudflare Worker 获取豆瓣书影音记录 - Untitled</title>
<meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,minimal-ui,shrink-to-fit=no"><link rel=stylesheet href=https://bigfa.github.io/hugo-theme-notability/scss/app.min.91802b9a856f04f7b78eaee5648f65b63e766eab3eee1fde4ab661faef88e9ab.css integrity="sha256-kYArmoVvBPe3jq7lZI9ltj52bqs+7h/eSrZh+u+I6as=" media=screen><link type=image/vnd.microsoft.icon href=/hugo-theme-notability/images/favicon.png rel="shortcut icon"><meta property="og:title" content="使用 Cloudflare Worker 获取豆瓣书影音记录"><meta property="og:url" content="https://bigfa.github.io/hugo-theme-notability/story/douban-cf-worker/"><meta property="og:image" content><meta property="og:description" content><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content><meta name=twitter:title content="使用 Cloudflare Worker 获取豆瓣书影音记录"><meta name=twitter:description content></head><body><script>window.DEFAULT_THEME="",localStorage.getItem("theme")==null&&localStorage.setItem("theme",window.DEFAULT_THEME),localStorage.getItem("theme")=="dark"&&document.querySelector("body").classList.add("dark"),localStorage.getItem("theme")=="auto"&&document.querySelector("body").classList.add("auto")</script><header class="metabar metabar--bordered"><div class="metabar--block layoutSingleColumn" itemprop=publisher itemscope itemtype=https://schema.org/Organization><h1 class=metabar--headline itemprop=logo itemscope itemtype=https://schema.org/ImageObject><a href=https://bigfa.github.io/hugo-theme-notability/ class=metabar--logo><img src=/hugo-theme-notability/images/logo.png class=metabar--logoImage width=38 height=47></a></h1><nav class=site--nav><a href=/hugo-theme-notability/movies/>书影音</a>
<a href=/hugo-theme-notability/cats/>分类</a>
<a href=/hugo-theme-notability/archive/>文章</a>
<a href=/hugo-theme-notability/topics/>标签</a>
<a href=/hugo-theme-notability/gears/>设备</a>
<a href=/hugo-theme-notability/about/>关于</a>
<a href=/hugo-theme-notability/friends/>链接</a></nav><svg class="menu--icon" width="1em" height="1em" viewBox="0 0 24 14" fill="currentcolor" aria-hidden="true"><line x1="24" y1="1" y2="1" stroke="currentcolor" stroke-width="2"/><line x1="24" y1="7" x2="4" y2="7" stroke="currentcolor" stroke-width="2"/><line x1="24" y1="13" x2="8" y2="13" stroke="currentcolor" stroke-width="2"/></svg></div></header><div class=mask></div><main class=main><div class="layoutSingleColumn u-paddingTop50 u-xs-paddingTop15 post--single" data-id=6d8338c48bc60010499d8d300f8c7e85><h2 class=article--headline>使用 Cloudflare Worker 获取豆瓣书影音记录</h2><div class=article--meta><time datetime='2024-05-15 17:41:05' class=humane--time>2024-05-15 17:41:05</time>
<span class=dot></span>
<a href=/hugo-theme-notability/category/hugo/>Hugo</a>
<span class=dot></span>
<span class=article--views></span></div><details class=toc open><summary class=toc-title>目录</summary><nav id=TableOfContents><ul><li><a href=#配置文件>配置文件</a></li><li><a href=#部署方法>部署方法</a></li><li><a href=#github-action-自动部署>Github Action 自动部署</a></li><li><a href=#初始化方法>初始化方法</a></li><li><a href=#接口>接口</a></li><li><a href=#前端展示>前端展示</a></li></ul></nav></details><div class="content graph"><blockquote><p>本功能直接解决豆瓣书影音记录两大痛点，自动同步和封面本地化，对于普通用户来说，Cloudflare 的免费版足够了，非常推荐使用。</p></blockquote><p><a href=https://github.com/bigfa/douban-cf-worker target=_blank rel=noopener>项目地址</a></p><p>之前我自己用 nodejs + mysql 写了一个同步豆瓣书影音的服务，但只在一个很隐蔽的地方公开了，主要是流量和数据库压力太大，提供公共服务成本实在是太高，最近在研究 Cloudflare Worker，试着把服务迁移过去，过程中发现几个问题。</p><ul><li>D1 单次请求操作次数是有限制的，最多一千次，读写都算。</li><li>Worker 子请求数最多就是 50 次，下载图片是占用这个次数的，初始化的时候如果下载图片基本都会超限失败。</li><li>Worker 直接读取 R2 输出图片的话速度很慢。</li></ul><p>不过多次测试之后还是找到了使用方法，虽然免费版有各种限制，但限制的都是单次请求，初始化的时候数据比较多，只需要在本地分页之后调用初始化接口就行了，后续使用定时任务同步不会因为请求过多而超限，除非在短时间内标记了大量内容。</p><p>电影</p><p><div class=doulist-item><div class=doulist-subject><div class=doulist-post><img decoding=async referrerpolicy=no-referrer src=https://dbapi.wpista.com/movie/26434828.jpg></div><div class=doulist-content><div class=doulist-title><a href=https://movie.douban.com/subject/26434828/ class=cute target=_blank rel="external nofollow">星际迷航4</a></div><div class=rating><span class=allstardark><span class=allstarlight style=width:0%></span></span><span class=rating_nums>0.0</span></div><div class=abstract>2028 / 美国 / 动作 科幻 惊悚 冒险 / 克里斯·派恩 扎克瑞·昆图</div></div></div></div></p><p>音乐</p><p><div class=doulist-item><div class=doulist-subject><div class=doulist-post><img decoding=async referrerpolicy=no-referrer src=https://dbapi.wpista.com/music/36766055.jpg></div><div class=doulist-content><div class=doulist-title><a href=https://music.douban.com/subject/36766055/ class=cute target=_blank rel="external nofollow">The Tortured Poets Department</a></div><div class=rating><span class=allstardark><span class=allstarlight style=width:68%></span></span><span class=rating_nums>6.8</span></div><div class=abstract>泰勒·斯威夫特 Taylor Swift / 2024</div></div></div></div></p><p>图书</p><p><div class=doulist-item><div class=doulist-subject><div class=doulist-post><img decoding=async referrerpolicy=no-referrer src=https://dbapi.wpista.com/book/36593622.jpg></div><div class=doulist-content><div class=doulist-title><a href=https://book.douban.com/subject/36593622/ class=cute target=_blank rel="external nofollow">世上为什么要有图书馆</a></div><div class=rating><span class=allstardark><span class=allstarlight style=width:91%></span></span><span class=rating_nums>9.1</span></div><div class=abstract>杨素秋 / 2024 / 上海译文出版社</div></div></div></div></p><p>为了简化数据库使用单表、所以电影不再支持类型了。新的单条目引用不会在标记列表中展示，后续如果该条目被标记则会自动更新，<strong>取消标记不会被同步</strong>。</p><p>自动同步使用了 Cloudflare 的 cron 触发器，实测还是比较好用的。同步时间可以根据自己的需求设置，默认配置是每 30 分钟同步一次。</p><pre tabindex=0><code>crons = [&#34;*/30 * * * *&#34;]
</code></pre><blockquote><p>如果未进行初始化直接进行同步，可能会因为 D1 操作次数过多报错而无法同步老数据，这时需要清空数据重新初始化，建议 worker 部署后第一时间初始化。</p></blockquote><h3 id=配置文件>配置文件</h3><p>Worker 配置文件 <code>wrangler.toml</code></p><pre tabindex=0><code>
[vars]
DOMAIN = &#34;https://bigfa.github.io&#34; // 跨域域名
DBID = 54529369 // 你的豆瓣ID
R2DOMAIN = &#34;https://db.wpista.com&#34; // R2 绑定域名
WOKRERDOMAIN = &#34;https://dbapi.wpista.com&#34; // worker 绑定域名
PAGESIZE = 40 // 每页显示数量
TYPES = &#34;movie,book,music,game,drama&#34; //初始化数据类型，支持五种，根据你的需要自行设置
STATUSES = &#34;done,mark,doing&#34; // 状态类型
TOKEN = &#34;richiscool&#34; // 初始化密钥，为了避免有人恶意调用同步接口，增加了一个token 验证

[[r2_buckets]]
binding = &#34;DOUBAN_BUCKET&#34;
bucket_name = &#34;douban&#34;

[[d1_databases]]
binding = &#34;DB&#34;
database_name = &#34;douban&#34;
database_id = &#34;c3f4fe6b-4fb2-4513-b7e9-3b264d3e3634&#34;

[triggers]
crons = [&#34;*/30 * * * *&#34;] // 自动同步任务设置规则
</code></pre><p>变量部分写了注释，r2 和 d1 绑定信息可在 Cloudflare 后台自行查看。</p><h3 id=部署方法>部署方法</h3><p>安装依赖</p><pre tabindex=0><code>npm install
</code></pre><p>初始化数据库，也可在后台创建。</p><pre tabindex=0><code>npx wrangler d1 create douban
</code></pre><p>本地</p><pre tabindex=0><code>npx wrangler d1 execute douban --local --file=./schema.sql
</code></pre><p>远程</p><pre tabindex=0><code>npx wrangler d1 execute douban --remote --file=./schema.sql
</code></pre><p>修改配置文件后部署</p><pre tabindex=0><code>npm run deploy
</code></pre><h3 id=github-action-自动部署>Github Action 自动部署</h3><p>clone 本项目或者直接 use this template</p><p>进入 Github 项目的设置，<code>Settings->Secrets and variables->Actions->Repository secret</code>，新增一个 <code>secret</code>，命名为 <code>CLOUDFLARE_API_TOKEN</code>。如果需要修改数据库名需要编辑<code>.github/workflows/deploy.yml</code>,douban 就是数据库名。</p><pre tabindex=0><code>wrangler d1 execute douban --file=./schema.sql
</code></pre><p><a href=https://dash.cloudflare.com/profile/api-tokens target=_blank rel=noopener>密钥设置地址</a>
，注意要给 D1 的编辑权限。</p><p>这样 main 分支有更新的时候就会自动部署了，部署前记得修改<code>wrangler.toml</code>配置文件。</p><h3 id=初始化方法>初始化方法</h3><p><strong>即使自动部署，初始化还是需要在本地完成，除非你的数据比较少，等着定时任务自动同步就好了。</strong></p><p>初始化配置文件<code>scripts/config.env</code></p><pre tabindex=0><code>DOUBAN_ID=54529369 // 你的豆瓣ID
TYPES=movie,music,book,game,drama //初始化数据类型，支持五种，根据你的需要自行设置
WORKER_URL=https://dbapi.wpista.com // worker 绑定域名
TOKEN=richiscool // 初始化密钥，为了避免有人恶意调用同步接口，增加了一个token 验证
STATUSES = done,mark,doing // 状态类型
</code></pre><p>命令</p><pre tabindex=0><code>npm run init
</code></pre><p>等待完成即可。</p><h3 id=接口>接口</h3><p>Worker 对外提供了 3 个接口，标记条目列表、单个条目信息、本地化条目封面。</p><ul><li>条目列表<code>/list</code>，支持两个参数 <code>type</code> 和 <code>paged</code>,<code>type</code> 为条目类型，<code>status</code> 为状态类型，<code>paged</code> 为页码，<code>get</code> 请求。</li><li>单个条目为<code>/:type/:id</code>,<code>type</code> 为类型，<code>id</code> 为条目 <code>id</code>。</li><li>本地化封面接口无序主动调用，在调用上面两个接口时会根据具体情况自动调用。</li></ul><h3 id=前端展示>前端展示</h3><p>和以前一样，强烈建议使用本人全家桶，如果想自行调用则可以参考主题目录下 <code>assets/ts/db.ts</code> 和样式<code>assets/scss/modules/_db.scss</code> 的文件。或者直接用 worker 接口自行开发。</p><p><code>db.ts</code> 已经被我封装成一个类，调用方法。</p><pre tabindex=0><code>new Douban({
    baseAPI: &#39;&#39;, // Worker api
    container: &#34;.db--container&#34;, // 容器名
});
</code></pre><p>现在<code>html</code>只需要如下结构</p><pre tabindex=0><code>&lt;div class=&#34;db--container&#34;&gt;&lt;/div&gt;
</code></pre><p>我自己测试了一阵子，使用上没啥大问题，比较稳定，偶尔有一直图片下载失败手动调用下接口重新下载即可。</p></div><div class=post--single__action><button class="button--like like-btn" aria-label="like the post">
<svg class="icon--active" viewBox="0 0 1024 1024" width="32" height="32"><path d="M780.8 204.8c-83.2-44.8-179.2-19.2-243.2 44.8L512 275.2l-25.6-25.6c-64-64-166.4-83.2-243.2-44.8-134.4 70.4-153.6 236.8-57.6 332.8l32 32 153.6 153.6 102.4 102.4c25.6 25.6 57.6 25.6 83.2.0l102.4-102.4 153.6-153.6 32-32C934.4 441.6 915.2 275.2 780.8 204.8z"/></svg>
<svg class="icon--default" viewBox="0 0 1024 1024" width="32" height="32"><path d="M332.8 249.6c38.4.0 83.2 19.2 108.8 44.8L467.2 320 512 364.8 556.8 320l25.6-25.6c32-32 70.4-44.8 108.8-44.8 19.2.0 38.4 6.4 57.6 12.8 44.8 25.6 70.4 57.6 76.8 108.8 6.4 44.8-6.4 89.6-38.4 121.6L512 774.4 236.8 492.8c-32-32-51.2-76.8-44.8-121.6s38.4-83.2 76.8-108.8C288 256 313.6 249.6 332.8 249.6m0-64C300.8 185.6 268.8 192 243.2 204.8 108.8 275.2 89.6 441.6 185.6 537.6l281.6 281.6C480 832 499.2 838.4 512 838.4s32-6.4 38.4-19.2L832 537.6c96-96 76.8-262.4-57.6-332.8-25.6-12.8-57.6-19.2-89.6-19.2-57.6.0-115.2 25.6-153.6 64L512 275.2l-25.6-25.6c-38.4-38.4-96-64-153.6-64z"/></svg>
<span class=count></span></button></div><div class="article--tags u-paddingTop20"></div><div class=postCat--item><img src=https://static.fatesinger.com/2023/06/u1ak8xgmyn9ec24r.png class=cover><div class=postCat--content><a href=/hugo-theme-notability/category/hugo/ class=artile--category>Hugo</a><p>The world’s fastest framework for building websites.(I don't believe it)</p></div></div><div class=post--ingle__comments data-id=6d8338c48bc60010499d8d300f8c7e85><div id=comments class=responsesWrapper><h3 class=comments--title><svg viewBox="0 0 24 24" class="icon" aria-hidden="true" width="16" height="16"><g><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49.0 8.129 3.64 8.129 8.13.0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317.0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36.0-3.39-2.744-6.13-6.129-6.13H9.756z"/></g></svg><span class=count></span></h3><ol class="commentlist sulliComment--list"></ol><nav class="commentnav u-textAlignCenter"></nav><div id=respond class=comment-respond><h3 id=reply-title class=comment-reply-title>发表回复 <small><a rel=nofollow id=cancel-comment-reply-link href=/39#respond style=display:none>取消回复</a></small></h3><form method=post id=commentform class=comment-form novalidate><p class=comment-notes><span id=email-notes>您的电子邮箱地址不会被公开。</span> <span class=required-field-message>必填项已用<span class=required>*</span>标注</span></p><p class=comment-form-author><label for=author>显示名称 <span class=required>*</span></label> <input id=author name=comment_author_name type=text size=30 maxlength=245 autocomplete=name required></p><p class=comment-form-email><label for=email>电子邮箱地址 <span class=required>*</span></label> <input id=email name=comment_author_email type=email size=30 maxlength=100 aria-describedby=email-notes autocomplete=email required></p><p class=comment-form-url><label for=url>网站地址</label> <input id=url name=url type=url size=30 maxlength=200 autocomplete=url></p><p class=comment-form-comment><label for=comment>评论 <span class=required>*</span></label>
<textarea id=comment name=comment_content cols=45 rows=8 maxlength=65525 required></textarea></p><p class=form-submit><input name=submit type=submit id=submit class=submit value=发表评论>
<input type=hidden name=post_id value=6d8338c48bc60010499d8d300f8c7e85 id=comment_post_ID>
<input type=hidden name=comment_parent id=comment_parent></p></form></div></div></div></div></main><footer class=site--footer><div class=layoutSingleColumn><div class=copyright>Theme by <a href=https://fatesinger.com/74850 target=_blank>bigfa</a>
© 版权所有
2024</div></div></footer><div class=backToTop><svg xmlns="http://www.w3.org/2000/svg" class="svgIcon" viewBox="0 0 14 14" fill="currentcolor" aria-hidden="true"><path d="M7.50015.425011C7.42998.354396 7.34632.298622 7.25415.261011c-.18314-.074008-.38786-.074008-.571.0C6.59128.298643 6.50795.354423 6.43815.425011L.728147 6.13201c-.13248.14218-.204603.33022-.201175.52452C.530401 6.85084.609113 7.03622.746526 7.17363c.137413.13742.322794.21613.517094.21956C1.45793 7.39661 1.64597 7.32449 1.78815 7.19201l4.428-4.427V13.024C6.21615 13.2229 6.29517 13.4137 6.43582 13.5543 6.57647 13.695 6.76724 13.774 6.96615 13.774 7.16506 13.774 7.35583 13.695 7.49648 13.5543 7.63713 13.4137 7.71615 13.2229 7.71615 13.024V2.76501l4.42795 4.427c.1427.13666.3325.21296.529999999999999.21296C12.8717 7.40497 13.0615 7.32867 13.2041 7.19201 13.3444 7.05126 13.4231 6.86068 13.4231 6.66201 13.4231 6.46334 13.3444 6.27277 13.2041 6.13201L7.50015.425011z"/></svg></div><script type=text/javascript>window.WPD_TOKEN="",window.commentDomain="https://fatesinger.com/__api/v1",window.actionDomain="https://v.wpista.com/",window.viewText=" 次浏览",window.dbAPIBase="https://dbapi.wpista.com/"</script><script type=text/javascript>window.timeFormat={second:"秒前",seconds:"秒前",minute:"",minutes:"",hour:"小时前",hours:"小时前",day:"天前",days:"天前",month:"月前",months:"月前"}</script><script type=text/javascript src=/hugo-theme-notability/ts/bundle.js defer></script></body></html>